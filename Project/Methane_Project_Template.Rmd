---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Methane Emissions Status for Manure Management across USA"
subtitle: "https://github.com/sultzerk/SultzerSwit_ENV872_EDA_FinalProject.git"
author: "Nadia Swit and Kendra Sultzer"
fontsize: 12pt
mainfont: Times New Roman

---

\newpage
\tableofcontents 
\newpage
**List of Tables**

1. Table 1: Structure of Variables of Interest in Analysis 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Get your working directory
getwd()

# Load your packages
library(tidyverse)
library(ggplot2)
library(lubridate)
library(trend)
library(Kendall)
library(agricolae)
library(cowplot)

# Set your ggplot theme
mytheme <- theme_classic(base_size = 14) + 
  theme(axis.text = element_text(color = "black"), 
        legend.position = "right", 
        legend.box.background = element_rect(color="black"), legend.background = element_blank(),  
        plot.title=element_text(hjust = 0.5))
#makes font size bigger, puts legend on right, puts box around legend, centers title in middle
theme_set(mytheme) #setting for all subsequent plots

# Load your datasets
Poop_raw <- read.csv("../Data/Raw/FAOSTAT_data_1980_2050.csv", stringsAsFactors = TRUE) 
```


# Rationale and Research Questions

For this project, we were interested in manure management and greenhouse gas emissions created by livestock.  Our initial dataset considered methane, nitrous oxide, and carbon dioxide. Research revealed that "livestock are reckoned to be responsible for up to 14% of all greenhouse emissions from human activities" (BBC article).  With such a substantial amount of human activities, we wanted to see how livestock factored into emissions. When considering different emission types, we focused on methane because methane is a very detrimental greenhouse gas: it traps heat at a rate 25 times greater than carbon dioxide (BBC article).  Methane gas explored here is produced by the anaerobic decomposition of manure stored or treated. Our research and data availability led us to these two research questions:


* Question 1: Have methane emissions changed over time?


* Question 2: Does the average methane emissions rate differ between each animal category?


\newpage

# Dataset Information

The dataset used for this project was retrieved from the Food & Agriculture Organization of the United Nations (FAO), specifically from FAOSTAT.  FAOSTAT provides free access to statistics pertaining to agriculture for over 245 countries.  For this analysis, we focused on emissions in the United States. *more info on how data was collected*

## Data Structure

**Table 1: Structure of Variables of Interest in Analysis**

**Variables** | **Units** | **Ranges** | **Central Tendencies**
----------------- | -------------------------- | --------------------- | ----------------
Total Methane Emissions | gigagrams CH4 | 0-670.9518  | 102.2441
Item | Animal | 13 animals: asses, cattle, chicken, ducks, goats, horses, mules, sheep, swine, turkey
Time | years | 1980-2050 (predicted 2030 and 2050)

\newpage

# Exploratory Analysis 

## Data wrangling steps

First, we viewed a summary of our data to decide how to pare it down and wrangle it. 
```{r, include=FALSE}
summary(Poop_raw)
```
We wanted to make our dataset more manageable, so we filtered for the specific columns we wanted to retain, the variable we were interested in (methane emissions), and only focused on historical data.  



```{r, wrangling, include=FALSE}
#data wrangling
CH4_time <- Poop_raw %>% 
  select(Element, Item, Year:Value)%>%  #filtering for just the columns we want 
  filter(Element == "Emissions (CH4) (Manure management)")%>%  #filtering for only total CH4 (methane)
  filter(Year %in% c(1980:2018)) #filter to remove projected years
#saving processed data
write.csv(CH4_time, file = "../Data/Processed/CH4_time.csv", row.names=FALSE)
```

In order effectively conduct a time series analysis, we made all the different livestock their own variables. We used the pivot_wider function to separate the livestock from the Items column into separate variables with their associated methane emission values. This allowed separate time series to be run on the desired livestock species.

```{r, wrangling, pivot_wider, include=FALSE}
#Separate animal items into individual columns
CH4_items <- pivot_wider(CH4_time, names_from=Item, values_from=Value)
#saving processed data
write.csv(CH4_items, file = "../Data/Processed/CH4_items.csv", row.names=FALSE)
```
## Basic visualizations

First, when considering our first research question, we wanted to see how methane emissions appear over time.  When combining all animals, we can see there is a general increasing trend over time (Figure 1). However, there is a sharp decrease in methane emissions at the beginning of the dataset (~1980-1985) that might warrant investigation later. For our analysis, we wanted to investigate whether this trend was significant. 

```{r, fig.cap="Methane Emissions Over Time", echo=FALSE, message=FALSE, warning=FALSE}
#making filtered dataset for averages
Total.CH4.allyears <- CH4_time %>% 
  group_by(Year) %>% 
  summarise(Mean.Methane=mean(Value),
            Sum.Methane=sum(Value))

#saving processed data
write.csv(Total.CH4.allyears, file="../Data/Processed/CH4_allyears.csv", row.names = FALSE)

#view lineplot
CH4.sum.plot <- ggplot(data=Total.CH4.allyears,aes(x=Year, y=Sum.Methane))+
  geom_line()+
  geom_smooth(method = lm )+
  labs(y="Total CH4 (gg)", title="Methane Emissions Over Time")+
  scale_y_continuous(limits = c(1200,1500))
CH4.sum.plot

```

We were also interested in the total emissions per animal. We visualized total methane emissions for each animal from 1980-2018 (Figure 2). It is evident that dairy cattle and market swine had the highest emission rates.

```{r, fig.cap="Methane Emissions by Animals", echo=FALSE, message=FALSE, warning=FALSE }
#simple visualization of methane emissions from animals 
CH4_animal_plot <- ggplot(CH4_time, aes(x=Year, y=Value, color=Item))+
  geom_line(size=1.1)+
  labs(y="Methane (gigagrams)", title = "Methane Emissions by Animals", col="Animal")
print(CH4_animal_plot)
```

Our second research question focused on the different emission rates between animals. We were curious about this question when we explored a boxplot showing the different rates (Figure 2). According to this boxplot, we suspected that there might be statistical differences since for, example: dairy cattle and market swine had higher rates than others. 

```{r, viewing boxplot of methane by animal, fig.cap="Average Methane Emissions by Animal", message=FALSE, warning=FALSE, echo=FALSE}
CH4.boxplot <- ggplot(data = CH4_time, aes(x=Item, y = Value))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  labs(title="Average Methane Emissions by Animal", x = "Animal", y = "CH4 Emissions (gg)")
CH4.boxplot
```

Additionally, to understand how the number of animals can influence total methane emissions, we visualized how head of animals differed between livestock category.Total livestock was visualized in Figure 4. To control for the the higher proportion of chickens, we removed them from the plot in Figure 5. 

```{r animal.head, fig.cap="Livestock Over Time", echo=FALSE}
#making lineplot to show head of animals over time
#filtering for only stocks (head of animals) and exclude future years

Stocks <- Poop_raw %>% 
  filter(Element == "Stocks") 

#full lineplot to show head of animals over time
Stock_plot <- ggplot(Stocks, aes(x=Year, y=Value, color=Item))+
  geom_line(size=1.1)+
  labs(y="Stocks (head)", title = "Livestock Over Time", col="Animal")
print(Stock_plot)
```

```{r no.chix, fig.cap="Livestock Over Time (Without Chickens)", echo=FALSE}
#making lineplot without chickens for better visualization
Stock_nochix <- Stocks %>% 
  filter(Item %in% c("Asses", "Cattle, dairy", "Cattle, non-dairy", "Chickens, layers", "Ducks", "Goats", "Horses", "Mules", "Sheep", "Swine, breeding", "Swine, market", "Turkeys") )

Stock_plot_nochix <- ggplot(Stock_nochix, aes(x=Year, y=Value, color=Item))+
  geom_line(size=1.1)+
  labs(y="Stocks (head)", title = "Livestock Over Time (Without Chickens)", col="Animal")
print(Stock_plot_nochix)
```


\newpage

# Analysis

## Research Question 1

To answer our first research question, we conducted a time series on the overall methane production for all livestock.  Since methane was only calculated once a year, there was no seasonality to our data, and we were not able to decompose our time series. However, we conducted a Mann-Kendall test, which confirmed that there was a significant trend (p-value < 0.05). From our data exploration, we can say that overall the trend is increasing: methane emissions between 1980 and 2018 have increased across 13 livestock in the United States.  

From visualizing the total emission rates, dairy cattle and market swine showed the highest emission rates. We also decided to conduct a time series analysis to determine if there was a significant trend. The Mann-Kendall test confirmed that a significant trend was present for both animals (p-value < 0.05). Dairy cattle (Figure 7) had an overall negative trend in emissions while market swine had a positive trend (Figure 8). 

```{r, time.series, include=FALSE}
#running time series
Total_ts <- ts(Total.CH4.allyears$Sum.Methane, start=1980, end=2018)

#run Mann-Kendall test to test for trend
Total_ts_mk <- mk.test(Total_ts)
Total_ts_mk #low p-value so there is a trend!

#Create time series component for dairy cattle
CH4_cattle_dairy_ts <- ts(CH4_items$`Cattle, dairy`, start=1980, end=2018)

#Run Mann-Kendall test to test for trend
CH4_cattle_dairy_mk <- mk.test(CH4_cattle_dairy_ts)
CH4_cattle_dairy_mk #low p-value so there is a trend!

```



```{r dairy.cattle.ts, fig.cap="Methane Emissions of Dairy Cattle", echo=FALSE, message=FALSE, warning=FALSE}
Cattle_dairy_plot <-
ggplot(CH4_items, aes(x = Year, y = `Cattle, dairy`)) +
  geom_line() +
  labs(y="CH4 Emissions (gigagrams)", title="Methane Emissions for Dairy Cattle", x="Year") +
  geom_smooth( method = lm )+
  ylim(400,650)
print(Cattle_dairy_plot)
```


```{r market.swine.ts, fig.cap = "Methane Emissions of Market Swine", echo=FALSE, message=FALSE, warning=FALSE}
Swine_market_plot <-
ggplot(CH4_items, aes(x = Year, y = `Swine, market`)) +
  geom_line() +
  labs(y="CH4 Emissions (gigagrams)", title="Methane Emissions for Market Swine", x="Year") +
  geom_smooth( method = lm )+
  ylim(400,650)
print(Swine_market_plot)
```

## Research Question 2
To answer the second research question, we conducted a one-way ANOVA test to evaluate whether the different animals, on average, have different emission rates.  To begin this process, we had to test the emission rates for normality.  The important assumption for generalized linear models is the normality of residuals.  The Shapiro-Wilk test showed that, of the 13 livestock, only ducks, breeding swine, and market swine were normally distributed. When viewing a Q-Q plot, once can see the data does not follow a normal distribution (Figure 3). Lastly, Bartlett's test for homogeneity of variances was run, which revealed that the variances were not equal (p < 0.05).  Even though all of the tests for normality failed, we proceeded on with the analysis.  

```{r, anova normality test, include=FALSE}
# Test for normality. 
# Note: the important assumption for GLMs is normality of residuals, 
# not necessarily normality of raw data. See below when we plot the model.
# shapiro.test() performs the Shapiro-Wilk test of the null that data follows a normal distribution

shapiro.test(CH4_time$Value[CH4_time$Item == "Asses"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Cattle, dairy"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Cattle, non-dairy"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Chickens, broilers"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Chickens, layers"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Goats"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Ducks"]) #normally distributed
shapiro.test(CH4_time$Value[CH4_time$Item == "Horses"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Mules"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Sheep"]) #not normal
shapiro.test(CH4_time$Value[CH4_time$Item == "Swine, breeding"]) #normally dist
shapiro.test(CH4_time$Value[CH4_time$Item == "Swine, market"]) #normally dist
shapiro.test(CH4_time$Value[CH4_time$Item == "Turkeys"]) #not normal
#most of animals are not normally distributed-reject null in all but 3 cases

# Test for equal variance
# ANOVA is robust against departures from equal variance.
# bartlett.test() performs Bartlett's test of the null that the variances in each of the groups (samples) are the same.
bartlett.test(CH4_time$Value ~ CH4_time$Item)
#results: reject null i.e. variances are not equal

```

```{r, echo=FALSE, fig.cap="QQ plot"}
qqnorm(CH4_time$Value); qqline(CH4_time$Value)
#data does not follow a normal distribution- some points are way higher quantiles
#not normal but deciding to proceed anyway
```

Our analysis then revealed that there was a significant difference in mean emissions among animals (ANOVA; F: 4394 on 12 and 494 DF,p<0.05).  But which animals had different means? A Tukey's HSD test helped show which means were different between the animals.  We extracted groupings for pair-wise relationships where the letters in Figure 4 represent the different groupings.  Thus, asses, ducks, goats, mules, and sheep all had statistically similar emission rates (Figure 4). Most of the other animals, such as market swine and dairy cattle, have their own grouping. 

```{r, anova, include=FALSE}
# Format ANOVA as aov
CH4.anova <- aov(data=CH4_time, Value ~ Item)
summary(CH4.anova)
#results: reject null hypothesis i.e. difference between a pair of animals is statistically significant
#but it's not telling us which animals aren't the same

# Format ANOVA as lm
CH4.anova2 <- lm(data=CH4_time, Value ~ Item)
summary(CH4.anova2)
#intercept represents asses here
#wow, this R2 is 99%!

# Checking model fit and assumptions
# ANOVA is not? robust against departures from normality.
plot(CH4.anova2)

# Post-hoc test
# TukeyHSD() computes Tukey Honest Significant Differences
TukeyHSD(CH4.anova)
#outputs all of differences for sites-pvalue for multiple comparisons

# Extract groupings for pairwise relationships
CH4.groups <- HSD.test(CH4.anova, "Item", group = TRUE)
CH4.groups
#sheep, goats, ducks, asses, mules are all in same grouping
```

```{r, anova results, echo=FALSE, fig.cap="Animal Groupings of Methane Emissions"}
# Graph the results
CH4.groups.plot <- ggplot(CH4_time, aes(x=Item, y = Value))+
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  stat_summary(geom="text", fun=max, vjust=-0.5, size=3.5,
               label=c("h", "b", "d", "f", "e", "h", "h", "gh", "h", "h", "c", "a", "fg"), col="purple")+
  labs(x="Animal", y = "CH4 Emissions (gigagrams)", title ="Animal Groupings of Methane Emissions")
CH4.groups.plot
```

\newpage

# Summary and Conclusions

With approximately a tenth of all methane emissions coming from manure collections ponds, amounts of manure must be considered and properly managed (Horn, 2018). To summarize, we investigated how methane emissions changed over time and how they differed between livestock. Our analysis revealed a significant upward trend in emissions over time across all selected livestock in the USA. The animals with the highest emissions, dairy cattle and market swine, exhibited significant trends with dairy cattle decreasing and market swine increasing from 1980-2018. A one-way ANOVA test confirmed that there were significant differences in methane emission rates between animals. The Tukey's HSD test resulted in 8 groups, with asses, ducks, goats, mules, and sheep being paired in the lowest emitting group. Dairy cattle and market swine had their own groups and were the highest emitters. 

Further analysis could include researching the decrease in total methane emissions between ~1980-1985. Within this dataset, additional research avenues include assesing trends in other green house gases, including nitrous oxide and carbon dioxide emissions. Our research did not include methane emissions from non-manure sources, including cattle burping. However, recent strides in research includes innovative solutions to reducing methane produced and emitted by livestock. Such innovations include burp backpacks, and vaccinations for reducing methane producing microbes(Bustamante, 2008). 

\newpage

# References

Bustamante, J. (2008, July 8). Cow burps help Argentines study climate change. Reuters. https://www.reuters.com/article/us-argentina-cows/cow-burps-help-argentines-study-climate-change-idUSN0830630220080709.

FAO (2020). FAOSTAT Emissions Database, Agriculture, Manure Management [Data set]. 
http://www.fao.org/faostat/en/#data/GM

Horn, P. (2018, October 24). Livestock-based methane emissions [Infographic]. Inside Climate News; EPA; FAO. https://insideclimatenews.org/news/24102018/infographic-farm-soil-carbon-cycle-climate-change-solution-agriculture/

Watts, G. (2019, August 6). The cows that could help fight climate change. BBC. https://www.bbc.com/future/article/20190806-how-vaccines-could-fix-our-problem-with-cow-emissions



 


